<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* ── Student card in the Students tab ── */
        .student-panel {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,.06);
            transition: box-shadow .2s;
        }
        .student-panel:hover { box-shadow: 0 4px 14px rgba(0,0,0,.12); }

        .student-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .9rem 1.2rem;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #dee2e6;
        }
        .student-panel-header:hover { background: #e9f0fb; }

        .student-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-weight: 700; font-size: .95rem;
            flex-shrink: 0;
        }

        .grade-pill {
            display: inline-block;
            min-width: 54px;
            text-align: center;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: .78rem;
            font-weight: 600;
        }
        .grade-pill.excellent { background:#d4edda; color:#155724; }
        .grade-pill.good      { background:#d1ecf1; color:#0c5460; }
        .grade-pill.fair      { background:#fff3cd; color:#856404; }
        .grade-pill.poor      { background:#f8d7da; color:#721c24; }

        /* compact inner submission table */
        .sub-inner-table th,
        .sub-inner-table td { font-size: .82rem; vertical-align: middle; }
        .sub-inner-table { margin-bottom: 0; }

        /* Tab pill overrides */
        .nav-tabs .nav-link { font-size: .93rem; }
        .tab-count-badge {
            background: #6c757d; color:#fff;
            border-radius: 20px;
            padding: 1px 8px;
            font-size: .72rem;
            margin-left: 5px;
            vertical-align: middle;
        }
        /* search box */
        #studentSearch { max-width: 280px; }
    </style>
</head>
<body class="results-page">
<div class="teacher-layout">
    <!-- Left sidebar -->
    <div th:replace="~{teacher-nav :: teacherNav}"></div>

    <!-- Main content area -->
    <div class="teacher-content-wrapper">
    <div class="container-fluid">
        <!-- Header -->
        <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-white">
                    <i class="bi bi-bar-chart-line"></i> 
                    Quiz Results Dashboard
                </h2>
                <p class="text-white-50 mb-0">
                    View all quiz and exam submissions from your students.
                </p>
            </div>
            <div>
                <a th:href="@{/teacher/homepage}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <i class="bi bi-file-earmark-text" style="font-size: 2rem;"></i>
                    <h3 th:text="${stats.totalSubmissions}">0</h3>
                    <p>Total Submissions</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                    <h3 th:text="${stats.gradedCount}">0</h3>
                    <p>Graded</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                    <h3 th:text="${stats.pendingCount}">0</h3>
                    <p>Pending Grading</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <i class="bi bi-trophy" style="font-size: 2rem;"></i>
                    <h3 th:text="${stats.averagePercentage + '%'}">0%</h3>
                    <p>Average Score</p>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════ TABS ═══════════════════════════════ -->
        <div class="results-card">
            <ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="submissions-tab"
                            data-bs-toggle="tab" data-bs-target="#tab-submissions"
                            type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-1"></i> Submissions
                        <span class="tab-count-badge" th:text="${submissions.size()}">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="grade-tab"
                            data-bs-toggle="tab" data-bs-target="#tab-grade"
                            type="button" role="tab">
                        <i class="bi bi-clipboard-check me-1"></i> Grade
                        <span class="tab-count-badge"
                              th:classappend="${totalPending > 0 ? ' bg-warning text-dark' : ''}"
                              th:text="${totalPending}">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="students-tab"
                            data-bs-toggle="tab" data-bs-target="#tab-students"
                            type="button" role="tab">
                        <i class="bi bi-people-fill me-1"></i> Students &amp; Grades
                        <span class="tab-count-badge" th:text="${studentSummaryList != null ? studentSummaryList.size() : 0}">0</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="resultsTabContent">

                <!-- ─────────────── TAB 1 : SUBMISSIONS ─────────────── -->
                <div class="tab-pane fade show active" id="tab-submissions" role="tabpanel">

                    <!-- Filters -->
                    <div class="filter-section mb-3">
                        <h6 class="mb-2 text-muted"><i class="bi bi-funnel"></i> Filter Results</h6>
                        <form th:action="@{/teacher/view-results}" method="get" class="row g-2">
                            <div class="col-md-3">
                                <select name="examFilter" class="form-select form-select-sm">
                                    <option value="">All Exams</option>
                                    <option th:each="exam : ${uniqueExams}"
                                            th:value="${exam}" th:text="${exam}"
                                            th:selected="${exam == examFilter}"></option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select name="subjectFilter" class="form-select form-select-sm">
                                    <option value="">All Subjects</option>
                                    <option th:each="subject : ${uniqueSubjects}"
                                            th:value="${subject}" th:text="${subject}"
                                            th:selected="${subject == subjectFilter}"></option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="studentFilter" class="form-select form-select-sm">
                                    <option value="">All Students</option>
                                    <option th:each="student : ${uniqueStudents}"
                                            th:value="${student}" th:text="${student}"
                                            th:selected="${student == studentFilter}"></option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select name="statusFilter" class="form-select form-select-sm">
                                    <option value="">All Status</option>
                                    <option value="graded"    th:selected="${statusFilter == 'graded'}">Graded</option>
                                    <option value="pending"   th:selected="${statusFilter == 'pending'}">Pending</option>
                                    <option value="released"  th:selected="${statusFilter == 'released'}">Released</option>
                                    <option value="unreleased" th:selected="${statusFilter == 'unreleased'}">Not Released</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div class="col-md-1">
                                <a th:href="@{/teacher/view-results}" class="btn btn-outline-secondary btn-sm w-100"
                                   title="Clear Filters"><i class="bi bi-x-circle"></i></a>
                            </div>
                        </form>
                    </div>

                    <!-- Submissions Table -->
                    <div class="table-wrapper">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Exam Name</th>
                                    <th>Subject</th>
                                    <th>Type</th>
                                    <th>Score</th>
                                    <th>%</th>
                                    <th>Grade</th>
                                    <th>Release</th>
                                    <th>Submitted</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${submissions.isEmpty()}">
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                        <p class="mt-2">No submissions found matching the filters.</p>
                                    </td>
                                </tr>
                                <tr th:each="submission : ${submissions}">
                                    <td>
                                        <strong th:text="${submission.studentEmail}">student@example.com</strong>
                                    </td>
                                    <td th:text="${submission.examName}">Exam Name</td>
                                    <td><span class="badge bg-info" th:text="${submission.subject}">Subject</span></td>
                                    <td>
                                        <span class="badge"
                                              th:classappend="${submission.activityType == 'Exam' ? 'bg-danger' : 'bg-primary'}"
                                              th:text="${submission.activityType}">Type</span>
                                    </td>
                                    <td>
                                        <span class="score-badge badge bg-secondary">
                                            <span th:text="${submission.score}">0</span> /
                                            <span th:text="${submission.totalQuestions}">0</span>
                                        </span>
                                    </td>
                                    <td>
                                        <strong th:text="${#numbers.formatDecimal(submission.percentage, 1, 1) + '%'}">0%</strong>
                                    </td>
                                    <td>
                                        <span th:if="${submission.graded}" class="badge badge-graded">
                                            <i class="bi bi-check-circle"></i> Graded
                                        </span>
                                        <span th:unless="${submission.graded}" class="badge badge-pending">
                                            <i class="bi bi-clock"></i> Pending
                                        </span>
                                    </td>
                                    <td>
                                        <span th:if="${submission.resultsReleased}" class="badge badge-released">
                                            <i class="bi bi-eye"></i> Released
                                        </span>
                                        <span th:unless="${submission.resultsReleased}" class="badge badge-unreleased">
                                            <i class="bi bi-eye-slash"></i> Unreleased
                                        </span>
                                    </td>
                                    <td>
                                        <small th:text="${#temporals.format(submission.submittedAt, 'MMM dd, yyyy HH:mm')}">Date</small>
                                    </td>
                                    <td>
                                        <a th:href="@{/teacher/view-result/{id}(id=${submission.id})}"
                                           class="btn btn-sm btn-primary action-btn" title="View Details">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        <a th:unless="${submission.isGraded()}"
                                           th:href="@{/teacher/grade/{id}(id=${submission.id})}"
                                           class="btn btn-sm btn-warning action-btn" title="Grade Submission">
                                            <i class="bi bi-pencil"></i> Grade
                                        </a>
                                        <form th:action="@{/teacher/toggle-result-release/{id}(id=${submission.id})}"
                                              method="post" style="display: inline;">
                                            <button type="submit"
                                                    th:classappend="${submission.resultsReleased ? 'btn-secondary' : 'btn-success'}"
                                                    class="btn btn-sm action-btn"
                                                    th:title="${submission.resultsReleased ? 'Hide from student' : 'Release to student'}">
                                                <i th:class="${submission.resultsReleased ? 'bi bi-eye-slash' : 'bi bi-eye'}"></i>
                                                <span th:text="${submission.resultsReleased ? 'Hide' : 'Release'}"></span>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Footer -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Showing:</strong>
                                    <span th:text="${submissions.size()}">0</span> submissions
                                </p>
                            </div>
                            <div class="col-md-6 text-end">
                                <p class="mb-1"><strong>Avg Score:</strong>
                                    <span th:text="${stats.averagePercentage + '%'}">0%</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div><!-- /tab-submissions -->

                <!-- ─────────────── TAB 2 : GRADE ─────────────── -->
                <div class="tab-pane fade" id="tab-grade" role="tabpanel">

                    <!-- Pending stats -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="stat-badge p-4 rounded-3 text-white text-center" style="background:linear-gradient(135deg,#f6d365,#fda085);">
                                <div class="display-6 fw-bold" th:text="${totalPending}">0</div>
                                <div><i class="bi bi-hourglass-split me-1"></i>Pending Grading</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-badge p-4 rounded-3 text-white text-center" style="background:linear-gradient(135deg,#11998e,#38ef7d);">
                                <div class="display-6 fw-bold" th:text="${gradedSubmissions != null ? gradedSubmissions.size() : 0}">0</div>
                                <div><i class="bi bi-check2-circle me-1"></i>Graded</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Section -->
                    <div class="mb-4">
                        <h5 class="mb-3 text-warning fw-semibold">
                            <i class="bi bi-hourglass-split me-1"></i> Needs Grading
                        </h5>
                        <div th:if="${pendingGrading == null or pendingGrading.isEmpty()}"
                             class="alert alert-success">
                            <i class="bi bi-check-circle me-1"></i> All submissions are graded!
                        </div>
                        <div class="table-responsive" th:if="${pendingGrading != null and !pendingGrading.isEmpty()}">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Subject</th>
                                        <th>Submitted</th>
                                        <th>Auto Score</th>
                                        <th>%</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="sub : ${pendingGrading}">
                                        <td><strong th:text="${sub.studentEmail}">student</strong></td>
                                        <td th:text="${sub.examName}">Exam</td>
                                        <td><span class="badge bg-info text-dark" th:text="${sub.subject}">Subject</span></td>
                                        <td><small th:text="${#temporals.format(sub.submittedAt,'MMM dd, yyyy HH:mm')}">-</small></td>
                                        <td>
                                            <span class="badge bg-secondary"
                                                  th:text="${sub.score} + ' / ' + ${sub.totalQuestions}">0/0</span>
                                        </td>
                                        <td>
                                            <span class="badge"
                                                  th:classappend="${sub.percentage >= 80 ? 'bg-success' : sub.percentage >= 60 ? 'bg-info' : sub.percentage >= 40 ? 'bg-warning text-dark' : 'bg-danger'}"
                                                  th:text="${#numbers.formatDecimal(sub.percentage,1,1)} + '%'">0%</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/teacher/grade/{id}(id=${sub.id})}"
                                               class="btn btn-sm btn-warning">
                                                <i class="bi bi-pencil-square me-1"></i> Grade Now
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Already Graded Section -->
                    <div>
                        <h5 class="mb-3 text-success fw-semibold">
                            <i class="bi bi-check2-circle me-1"></i> Already Graded
                        </h5>
                        <div th:if="${gradedSubmissions == null or gradedSubmissions.isEmpty()}"
                             class="text-muted text-center py-3">
                            <i class="bi bi-inbox me-1"></i> No graded submissions yet.
                        </div>
                        <div class="table-responsive" th:if="${gradedSubmissions != null and !gradedSubmissions.isEmpty()}">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Subject</th>
                                        <th>Score</th>
                                        <th>Grade %</th>
                                        <th>Released</th>
                                        <th>Graded At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="sub : ${gradedSubmissions}">
                                        <td><strong th:text="${sub.studentEmail}">student</strong></td>
                                        <td th:text="${sub.examName}">Exam</td>
                                        <td><span class="badge bg-info text-dark" th:text="${sub.subject}">Subject</span></td>
                                        <td>
                                            <span class="badge bg-secondary"
                                                  th:text="${sub.finalScore} + ' / ' + ${sub.totalQuestions}">0/0</span>
                                        </td>
                                        <td>
                                            <span th:with="pct=${sub.finalPercentage}"
                                                  th:class="${'grade-pill ' + (pct >= 90 ? 'excellent' : (pct >= 75 ? 'good' : (pct >= 50 ? 'fair' : 'poor')))}"
                                                  th:text="${#numbers.formatDecimal(pct,1,1)} + '%'">0%</span>
                                        </td>
                                        <td>
                                            <span th:if="${sub.resultsReleased}" class="badge bg-info text-dark">
                                                <i class="bi bi-eye me-1"></i>Released
                                            </span>
                                            <span th:unless="${sub.resultsReleased}" class="badge bg-secondary">
                                                <i class="bi bi-eye-slash me-1"></i>Locked
                                            </span>
                                        </td>
                                        <td>
                                            <small th:if="${sub.gradedAt != null}"
                                                   th:text="${#temporals.format(sub.gradedAt,'MMM dd, yyyy')}">-</small>
                                            <small th:if="${sub.gradedAt == null}" class="text-muted">-</small>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1 flex-wrap">
                                                <a th:href="@{/teacher/view-result/{id}(id=${sub.id})}"
                                                   class="btn btn-xs btn-primary" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <form th:action="@{/teacher/toggle-result-release/{id}(id=${sub.id})}"
                                                      method="post" style="display:inline">
                                                    <button type="submit"
                                                            th:class="${'btn btn-xs ' + (sub.resultsReleased ? 'btn-secondary' : 'btn-outline-success')}"
                                                            th:title="${sub.resultsReleased ? 'Lock result' : 'Release result'}">
                                                        <i th:class="${sub.resultsReleased ? 'bi bi-eye-slash' : 'bi bi-eye'}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- /tab-grade -->

                <!-- ─────────────── TAB 3 : STUDENTS & GRADES ─────────────── -->
                <div class="tab-pane fade" id="tab-students" role="tabpanel">

                    <!-- Search & legend row -->
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <span class="badge bg-success">Graded</span>
                            <span class="badge bg-warning text-dark">Pending</span>
                            <span class="badge bg-info text-dark">Released</span>
                            <span class="badge bg-secondary">Locked</span>
                        </div>
                        <input type="text" id="studentSearch" class="form-control form-control-sm"
                               placeholder="&#x1F50D;  Search student name or email…">
                    </div>

                    <!-- Empty state -->
                    <div th:if="${studentSummaryList == null or studentSummaryList.isEmpty()}" class="text-center py-5 text-muted">
                        <i class="bi bi-people display-4"></i>
                        <p class="mt-2">No enrolled students found.</p>
                    </div>

                    <!-- Student panels -->
                    <div id="studentPanelList">
                        <div th:each="student, si : ${studentSummaryList != null ? studentSummaryList : #lists.emptyList()}"
                             class="student-panel"
                             th:attr="data-search-key=${#strings.toLowerCase(student.studentName) + ' ' + #strings.toLowerCase(student.studentEmail)}">

                            <!-- Collapsed header -->
                            <div class="student-panel-header"
                                 th:attr="data-bs-toggle='collapse',
                                          data-bs-target='#studentCollapse' + ${si.index},
                                          aria-expanded='false',
                                          aria-controls='studentCollapse' + ${si.index}">

                                <div class="d-flex align-items-center gap-3">
                                    <!-- Avatar: first letter of student name -->
                                    <div class="student-avatar"
                                         th:text="${#strings.substring(student.studentName, 0, 1)}">S</div>

                                    <div>
                                        <div class="fw-semibold"
                                             th:text="${student.studentName}">Student Name</div>
                                        <div class="text-muted small">
                                            <i class="bi bi-envelope me-1"></i>
                                            <span th:text="${student.studentEmail}">email@example.com</span>
                                            <span th:if="${student.subjectName != null}"
                                                  class="ms-2 badge bg-light text-dark border">
                                                <i class="bi bi-journal-bookmark me-1"></i>
                                                <span th:text="${student.subjectName}">Subject</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stats badges -->
                                <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                    <span class="badge bg-primary rounded-pill"
                                          th:text="${student.totalSubmissions} + ' submission' + (${student.totalSubmissions != 1} ? 's' : '')">0 submissions</span>
                                    <span class="badge bg-success"
                                          th:if="${student.gradedCount > 0}"
                                          th:text="${student.gradedCount} + ' graded'">0 graded</span>
                                    <span class="badge bg-warning text-dark"
                                          th:if="${student.pendingCount > 0}"
                                          th:text="${student.pendingCount} + ' pending'">0 pending</span>
                                    <span class="badge bg-info text-dark"
                                          th:if="${student.releasedCount > 0}"
                                          th:text="${student.releasedCount} + ' released'">0 released</span>
                                    <span class="fw-semibold text-secondary ms-1"
                                          th:if="${student.gradedCount > 0}"
                                          th:text="'Avg: ' + ${student.averageScore} + '%'">Avg: 0%</span>
                                    <i class="bi bi-chevron-down ms-2 text-muted"></i>
                                </div>
                            </div><!-- /header -->

                            <!-- Collapsible body -->
                            <div th:id="'studentCollapse' + ${si.index}" class="collapse">
                                <div class="p-3">

                                    <!-- Inner tab nav -->
                                    <ul class="nav nav-tabs mb-3" th:id="|sTabs-${si.index}|" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active"
                                                    data-bs-toggle="tab"
                                                    th:data-bs-target="|#sSubPane-${si.index}|"
                                                    type="button" role="tab">
                                                <i class="bi bi-table me-1"></i> Submissions &amp; Grades
                                                <span class="tab-count-badge" th:text="${student.totalSubmissions}">0</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link"
                                                    data-bs-toggle="tab"
                                                    th:data-bs-target="|#sAnaPane-${si.index}|"
                                                    type="button" role="tab">
                                                <i class="bi bi-bar-chart-line me-1"></i> Analytics
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content">

                                        <!-- ── SUB-TAB 1: Submissions & Grades ── -->
                                        <div class="tab-pane fade show active"
                                             th:id="|sSubPane-${si.index}|" role="tabpanel">

                                            <div th:if="${student.submissions.isEmpty()}" class="text-muted text-center py-3">
                                                <i class="bi bi-inbox me-1"></i> No submissions yet.
                                            </div>

                                            <div th:if="${!student.submissions.isEmpty()}" class="table-responsive">
                                                <table class="table sub-inner-table table-hover align-middle mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Exam</th>
                                                            <th>Subject</th>
                                                            <th>Type</th>
                                                            <th>Score</th>
                                                            <th>Grade %</th>
                                                            <th>Status</th>
                                                            <th>Release</th>
                                                            <th>Submitted</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr th:each="sub, subIdx : ${student.submissions}">
                                                            <td class="text-muted" th:text="${subIdx.count}">1</td>
                                                            <td><span class="fw-semibold" th:text="${sub.examName}">Exam</span></td>
                                                            <td><span class="badge bg-info text-dark" th:text="${sub.subject}">Subject</span></td>
                                                            <td>
                                                                <span class="badge"
                                                                      th:classappend="${sub.activityType == 'Exam' ? 'bg-danger' : 'bg-primary'}"
                                                                      th:text="${sub.activityType}">Type</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-secondary">
                                                                    <span th:text="${sub.score}">0</span>/<span th:text="${sub.totalQuestions}">0</span>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span th:with="pct=${sub.percentage}"
                                                                      th:class="${'grade-pill ' + (pct >= 90 ? 'excellent' : (pct >= 75 ? 'good' : (pct >= 50 ? 'fair' : 'poor')))}"
                                                                      th:text="${#numbers.formatDecimal(pct, 1, 1) + '%'}">0%</span>
                                                            </td>
                                                            <td>
                                                                <span th:if="${sub.graded}" class="badge bg-success">
                                                                    <i class="bi bi-check-circle"></i> Graded
                                                                </span>
                                                                <span th:unless="${sub.graded}" class="badge bg-warning text-dark">
                                                                    <i class="bi bi-clock"></i> Pending
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span th:if="${sub.resultsReleased}" class="badge bg-info text-dark">
                                                                    <i class="bi bi-eye"></i> Released
                                                                </span>
                                                                <span th:unless="${sub.resultsReleased}" class="badge bg-secondary">
                                                                    <i class="bi bi-eye-slash"></i> Locked
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <small class="text-nowrap"
                                                                       th:text="${#temporals.format(sub.submittedAt, 'MMM dd, yyyy HH:mm')}">Date</small>
                                                            </td>
                                                            <td>
                                                                <div class="d-flex gap-1 flex-wrap">
                                                                    <a th:href="@{/teacher/view-result/{id}(id=${sub.id})}"
                                                                       class="btn btn-xs btn-primary" title="View">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <a th:unless="${sub.isGraded()}"
                                                                       th:href="@{/teacher/grade/{id}(id=${sub.id})}"
                                                                       class="btn btn-xs btn-warning" title="Grade">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </a>
                                                                    <form th:action="@{/teacher/toggle-result-release/{id}(id=${sub.id})}"
                                                                          method="post" style="display:inline">
                                                                        <button type="submit"
                                                                                th:class="${'btn btn-xs ' + (sub.resultsReleased ? 'btn-secondary' : 'btn-outline-success')}"
                                                                                th:title="${sub.resultsReleased ? 'Lock result' : 'Release result'}">
                                                                            <i th:class="${sub.resultsReleased ? 'bi bi-eye-slash' : 'bi bi-eye'}"></i>
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div><!-- /sSubPane -->

                                        <!-- ── SUB-TAB 2: Analytics ── -->
                                        <div class="tab-pane fade"
                                             th:id="|sAnaPane-${si.index}|" role="tabpanel">

                                            <div th:if="${!student.hasAnalytics}" class="text-center text-muted py-4">
                                                <i class="bi bi-bar-chart fs-2 d-block mb-2"></i>
                                                No analytics yet — available after graded submissions.
                                            </div>

                                            <div th:if="${student.hasAnalytics}">
                                                <!-- Performance category banner -->
                                                <div class="d-flex align-items-center gap-2 mb-3 p-3 rounded-3 text-white"
                                                     style="background:linear-gradient(90deg,#1a3c6e,#2a5298);">
                                                    <span class="small opacity-75">Latest Performance Category:</span>
                                                    <span class="fw-bold px-3 py-1 rounded-2"
                                                          style="background:rgba(255,255,255,.2);"
                                                          th:text="${student.latestCategory}">N/A</span>
                                                </div>

                                                <!-- Radar chart -->
                                                <div class="d-flex justify-content-center mb-3">
                                                    <div style="width:320px;height:320px;position:relative;">
                                                        <canvas th:id="|radarChart-${si.index}|"
                                                                th:data-mastery="${student.avgTopicMastery}"
                                                                th:data-accuracy="${student.avgAccuracy}"
                                                                th:data-resilience="${student.avgDifficultyResilience}"
                                                                th:data-time="${student.avgTimeEfficiency}"
                                                                th:data-confidence="${student.avgConfidence}">
                                                        </canvas>
                                                    </div>
                                                </div>
                                                <div class="row g-2 mb-3">
                                                    <!-- Topic Mastery -->
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 border bg-light">
                                                            <div class="text-muted small fw-semibold mb-1">
                                                                <i class="bi bi-bullseye me-1" style="color:#1a3c6e;"></i>Topic Mastery
                                                            </div>
                                                            <div class="fw-bold fs-5" style="color:#1a3c6e;"
                                                                 th:text="${student.avgTopicMastery} + '%'">0%</div>
                                                            <div class="progress mt-1" style="height:5px;">
                                                                <div class="progress-bar" style="background:#1a3c6e;"
                                                                     th:style="|width:${student.avgTopicMastery}%;background:#1a3c6e;|"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Accuracy -->
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 border bg-light">
                                                            <div class="text-muted small fw-semibold mb-1">
                                                                <i class="bi bi-check2-circle me-1" style="color:#1a6e3c;"></i>Accuracy
                                                            </div>
                                                            <div class="fw-bold fs-5" style="color:#1a6e3c;"
                                                                 th:text="${student.avgAccuracy} + '%'">0%</div>
                                                            <div class="progress mt-1" style="height:5px;">
                                                                <div class="progress-bar" style="background:#1a6e3c;"
                                                                     th:style="|width:${student.avgAccuracy}%;background:#1a6e3c;|"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Difficulty Resilience -->
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 border bg-light">
                                                            <div class="text-muted small fw-semibold mb-1">
                                                                <i class="bi bi-shield-check me-1" style="color:#b8860b;"></i>Difficulty Resilience
                                                            </div>
                                                            <div class="fw-bold fs-5" style="color:#b8860b;"
                                                                 th:text="${student.avgDifficultyResilience} + '%'">0%</div>
                                                            <div class="progress mt-1" style="height:5px;">
                                                                <div class="progress-bar"
                                                                     th:style="|width:${student.avgDifficultyResilience}%;background:#b8860b;|"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Time Efficiency -->
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 border bg-light">
                                                            <div class="text-muted small fw-semibold mb-1">
                                                                <i class="bi bi-stopwatch me-1" style="color:#7b1113;"></i>Time Efficiency
                                                            </div>
                                                            <div class="fw-bold fs-5" style="color:#7b1113;"
                                                                 th:text="${student.avgTimeEfficiency} + '%'">0%</div>
                                                            <div class="progress mt-1" style="height:5px;">
                                                                <div class="progress-bar"
                                                                     th:style="|width:${student.avgTimeEfficiency}%;background:#7b1113;|"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Confidence -->
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 border bg-light">
                                                            <div class="text-muted small fw-semibold mb-1">
                                                                <i class="bi bi-lightning-charge me-1" style="color:#6f42c1;"></i>Confidence
                                                            </div>
                                                            <div class="fw-bold fs-5" style="color:#6f42c1;"
                                                                 th:text="${student.avgConfidence} + '%'">0%</div>
                                                            <div class="progress mt-1" style="height:5px;">
                                                                <div class="progress-bar"
                                                                     th:style="|width:${student.avgConfidence}%;background:#6f42c1;|"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div><!-- /row -->

                                                <!-- Per-submission analytics breakdown -->
                                                <div class="table-responsive">
                                                    <table class="table sub-inner-table table-hover align-middle mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Exam</th>
                                                                <th>Date</th>
                                                                <th>Category</th>
                                                                <th>Topic Mastery</th>
                                                                <th>Accuracy</th>
                                                                <th>Resilience</th>
                                                                <th>Time Eff.</th>
                                                                <th>Confidence</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr th:each="sub : ${student.submissions}" th:if="${sub.graded}">
                                                                <td th:text="${sub.examName}">Exam</td>
                                                                <td><small th:text="${#temporals.format(sub.submittedAt,'MMM dd, yyyy')}">-</small></td>
                                                                <td>
                                                                    <span class="badge bg-primary"
                                                                          th:if="${sub.performanceCategory != null}"
                                                                          th:text="${sub.performanceCategory}">-</span>
                                                                    <span th:if="${sub.performanceCategory == null}" class="text-muted">-</span>
                                                                </td>
                                                                <td th:text="${#numbers.formatDecimal(sub.topicMastery,1,1)} + '%'">0%</td>
                                                                <td th:text="${#numbers.formatDecimal(sub.accuracy,1,1)} + '%'">0%</td>
                                                                <td th:text="${#numbers.formatDecimal(sub.difficultyResilience,1,1)} + '%'">0%</td>
                                                                <td th:text="${#numbers.formatDecimal(sub.timeEfficiency,1,1)} + '%'">0%</td>
                                                                <td th:text="${#numbers.formatDecimal(sub.confidence,1,1)} + '%'">0%</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><!-- /hasAnalytics -->
                                        </div><!-- /sAnaPane -->

                                    </div><!-- /tab-content -->
                                </div>
                            </div><!-- /collapse -->
                        </div><!-- /student-panel -->
                    </div><!-- /studentPanelList -->
                </div><!-- /tab-students -->

            </div><!-- /tab-content -->
        </div><!-- /results-card -->
    </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* Live search in Students tab */
    document.getElementById('studentSearch').addEventListener('input', function () {
        const q = this.value.toLowerCase().trim();
        document.querySelectorAll('#studentPanelList .student-panel').forEach(panel => {
            const key = panel.dataset.searchKey || '';
            panel.style.display = (!q || key.includes(q)) ? '' : 'none';
        });
    });

    /* Rotate chevron icon on collapse toggle */
    document.querySelectorAll('.student-panel-header').forEach(header => {
        const target = document.querySelector(header.dataset.bsTarget);
        if (!target) return;
        target.addEventListener('show.bs.collapse', () => {
            header.querySelector('.bi-chevron-down').classList.replace('bi-chevron-down','bi-chevron-up');
        });
        target.addEventListener('hide.bs.collapse', () => {
            header.querySelector('.bi-chevron-up').classList.replace('bi-chevron-up','bi-chevron-down');
        });
    });

    /* ── Radar Charts ── */
    const radarInstances = {};

    function renderRadarChart(index) {
        const canvasId = 'radarChart-' + index;
        if (radarInstances[canvasId]) return; // already rendered

        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const mastery    = parseFloat(canvas.dataset.mastery)    || 0;
        const accuracy   = parseFloat(canvas.dataset.accuracy)   || 0;
        const resilience = parseFloat(canvas.dataset.resilience) || 0;
        const time       = parseFloat(canvas.dataset.time)       || 0;
        const confidence = parseFloat(canvas.dataset.confidence) || 0;

        radarInstances[canvasId] = new Chart(canvas, {
            type: 'radar',
            data: {
                labels: ['Topic Mastery', 'Accuracy', 'Difficulty Resilience', 'Time Efficiency', 'Confidence'],
                datasets: [{
                    label: 'Avg Performance',
                    data: [mastery, accuracy, resilience, time, confidence],
                    backgroundColor: 'rgba(102,126,234,0.25)',
                    borderColor: 'rgba(102,126,234,1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102,126,234,1)',
                    pointBorderColor: '#fff',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: '5-Dimension Performance',
                        font: { size: 13, weight: 'bold' },
                        color: '#1a3c6e'
                    }
                },
                scales: {
                    r: {
                        min: 0, max: 100,
                        ticks: { stepSize: 25, font: { size: 10 }, backdropColor: 'transparent' },
                        pointLabels: { font: { size: 11, weight: '600' }, color: '#444' },
                        grid: { color: 'rgba(0,0,0,0.08)' },
                        angleLines: { color: 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });
    }

    /* Render radar when Analytics sub-tab becomes visible */
    document.querySelectorAll('[data-bs-target^="#sAnaPane-"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', function () {
            const target = this.getAttribute('data-bs-target'); // e.g. "#sAnaPane-0"
            const index  = target.replace('#sAnaPane-', '');
            renderRadarChart(index);
        });
    });
</script>
</body>
</html>
