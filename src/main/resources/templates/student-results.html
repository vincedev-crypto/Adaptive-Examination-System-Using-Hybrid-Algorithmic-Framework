<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Exam Results - ALGO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden { display: none; }
        #chartSection { margin-top: 2rem; }
        .performance-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff;
        }
        .answer-correct {
            border-left: 4px solid #198754;
        }
        .answer-incorrect {
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm border-0 p-5 text-center">
                    <div class="mb-4">
                        <div class="display-1 text-success">‚úì</div>
                        <h2 class="fw-bold">Exam Submitted!</h2>
                    </div>
                    <hr>
                    <div class="py-4">
                        <h4 class="text-secondary">Your Final Score</h4>
                        <h1 class="display-2 fw-bold text-primary" th:text="${score + ' / ' + total}"></h1>
                    </div>
                    
                    <!-- Answer Review Section -->
                    <div th:if="${answerDetails}" class="mt-4 mb-4">
                        <h4 class="text-start mb-3">üìù Answer Review</h4>
                        <div class="accordion" id="answerAccordion">
                            <div class="accordion-item" th:each="detail, iterStat : ${answerDetails}">
                                <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            th:data-bs-target="'#collapse' + ${iterStat.index}" 
                                            aria-expanded="false" 
                                            th:aria-controls="'collapse' + ${iterStat.index}">
                                        <span th:if="${detail.isCorrect}" class="text-success me-2">‚úì</span>
                                        <span th:if="${!detail.isCorrect}" class="text-danger me-2">‚úó</span>
                                        <strong>Question <span th:text="${detail.questionNumber}"></span></strong>
                                        <span th:if="${detail.isCorrect}" class="badge bg-success ms-2">Correct</span>
                                        <span th:if="${!detail.isCorrect}" class="badge bg-danger ms-2">Incorrect</span>
                                    </button>
                                </h2>
                                <div th:id="'collapse' + ${iterStat.index}" 
                                     class="accordion-collapse collapse" 
                                     th:aria-labelledby="'heading' + ${iterStat.index}" 
                                     data-bs-parent="#answerAccordion">
                                    <div class="accordion-body text-start">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="mb-2"><strong>Your Answer:</strong></p>
                                                <div class="alert" 
                                                     th:classappend="${detail.isCorrect ? 'alert-success' : 'alert-danger'}">
                                                    <span th:text="${detail.studentAnswer}"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-2"><strong>Correct Answer:</strong></p>
                                                <div class="alert alert-info">
                                                    <span th:text="${detail.correctAnswer}"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div th:if="${!detail.isCorrect}" class="alert alert-warning mt-2">
                                            <strong>üí° Tip:</strong> Review this topic to improve your understanding.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Random Forest Analytics Section -->
                    <div th:if="${analytics}" class="mt-4">
                        <h3>Performance Analysis (Random Forest)</h3>
                        <span class="badge performance-badge" 
                              th:classappend="${analytics.performanceCategory == 'Excellent' ? 'bg-success' : 
                                              analytics.performanceCategory == 'Good' ? 'bg-info' : 
                                              analytics.performanceCategory == 'Fair' ? 'bg-warning' : 'bg-danger'}"
                              th:text="${analytics.performanceCategory}"></span>
                        
                        <input type="hidden" id="tmScoreValue" th:value="${analytics.topicMastery}"/>
                        <input type="hidden" id="drScoreValue" th:value="${analytics.difficultyResilience}"/>
                        
                        <button id="renderRadarBtn" class="btn btn-success mt-3 btn-lg">
                            üìä View Detailed Performance Chart
                        </button>
                        
                        <div id="chartSection" class="hidden mt-4">
                            <canvas id="radarChartCanvas" width="400" height="400"></canvas>
                        </div>
                        
                        <!-- Performance Summary Box -->
                        <div class="alert alert-light mt-4 text-start">
                            <h5 class="alert-heading">Performance Summary (Random Forest Analysis)</h5>
                            <p><strong>Overall Score:</strong> <span th:text="${percentage != null ? #numbers.formatDecimal(percentage, 1, 2) + '%' : '0%'}"></span> - <span th:text="${analytics.performanceCategory}"></span></p>
                            <hr>
                            <p class="mb-2"><strong>Strengths:</strong> 
                                <span th:if="${analytics.topicMastery >= 70}">time Efficiency, </span>
                                <span th:if="${analytics.confidence >= 70}">confidence</span>
                            </p>
                            <p class="mb-0"><strong>Areas for Improvement:</strong> 
                                <span th:if="${analytics.difficultyResilience < 70}">difficulty Resilience, </span>
                                <span th:if="${analytics.accuracy < 70}">accuracy</span>
                            </p>
                        </div>
                    </div>
                    
                    <p class="text-muted mb-4 mt-4">
                        Great job! Your performance has been analyzed using Random Forest algorithms.
                    </p>
                    <a href="/student/dashboard" class="btn btn-outline-primary btn-lg">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/results-logic.js"></script>
</body>
</html>